!function(a){"function"==typeof define&&define.amd?define(["jquery","ChineseDistricts"],a):"object"==typeof exports?a(require("jquery"),require("ChineseDistricts")):a(jQuery,ChineseDistricts)}(function(a,b){"use strict";function h(b,c){this.$element=a(b),this.$dropdown=null,this.options=a.extend({},h.DEFAULTS,a.isPlainObject(c)&&c),this.active=!1,this.dems=[],this.needBlur=!1,this.options.valueField?this.$elementCode=a(this.options.valueField):this.$elementCode=this.$element.siblings(":hidden"),this.init()}if("undefined"==typeof b)throw new Error('The file "city-picker.data.js" must be included first!');var c="citypicker",d="change."+c,e="province",f="city",g="district";h.prototype={constructor:h,init:function(){this.defineDems(),this.render(),this.bind(),this.active=!0},render:function(){var b=this.getPosition(),c=this.$element.attr("placeholder")||this.options.placeholder,d='<span class="city-picker-span" style="'+this.getWidthStyle(b.width)+"height:"+b.height+"px;line-height:"+(b.height-1)+'px;">'+(c?'<span class="placeholder">'+c+"</span>":"")+'<span class="title"></span><div class="arrow"></div></span>',e='<div class="city-picker-dropdown" style="left:0px;top:100%;'+this.getWidthStyle(b.width,!0)+'"><div class="city-select-wrap"><div class="city-select-tab"><a class="active" data-count="province">省份</a>'+(this.includeDem("city")?'<a data-count="city">城市</a>':"")+(this.includeDem("district")?'<a data-count="district">区县</a>':"")+'</div><div class="city-select-content"><div class="city-select province" data-count="province"></div>'+(this.includeDem("city")?'<div class="city-select city" data-count="city"></div>':"")+(this.includeDem("district")?'<div class="city-select district" data-count="district"></div>':"")+"</div></div>";this.$element.addClass("city-picker-input"),this.$textspan=a(d).insertAfter(this.$element),this.$dropdown=a(e).insertAfter(this.$textspan);var f=this.$dropdown.find(".city-select");a.each(this.dems,a.proxy(function(a,b){this["$"+b]=f.filter("."+b)},this)),this.refresh()},refresh:function(b){var c=this.$dropdown.find(".city-select");c.data("item",null);var d=this.$element.val()||"";d=d.split("/"),a.each(this.dems,a.proxy(function(a,c){d[a]&&a<d.length?this.options[c]=d[a]:b&&(this.options[c]=""),this.output(c)},this)),this.tab(e),this.feedText(),this.feedVal()},defineDems:function(){var b=!1;a.each([e,f,g],a.proxy(function(a,c){b||this.dems.push(c),c===this.options.level&&(b=!0)},this))},includeDem:function(b){return a.inArray(b,this.dems)!==-1},getPosition:function(){var a,b,c,d,e;return a=this.$element.position(),d=this.getSize(this.$element),b=d.height,c=d.width,this.options.responsive&&(e=this.$element.offsetParent().width(),e&&(c/=e,c>.99&&(c=1),c=100*c+"%")),{top:a.top||0,left:a.left||0,height:b,width:c}},getSize:function(b){var c,d,e;return b.is(":visible")?e={width:b.outerWidth(),height:b.outerHeight()}:(c=a("<div />").appendTo(a("body")),c.css({position:"absolute !important",visibility:"hidden !important",display:"block !important"}),d=b.clone().appendTo(c),e={width:d.outerWidth(),height:d.outerHeight()},c.remove()),e},getWidthStyle:function(b,c){return this.options.responsive&&!a.isNumeric(b)?"width:"+b+";":"width:"+(c?Math.max(320,b):b)+"px;"},bind:function(){var b=this;a(document).on("click",this._mouteclick=function(c){var e,f,g,d=a(c.target);d.is(".city-picker-span")?f=d:d.is(".city-picker-span *")&&(f=d.parents(".city-picker-span")),d.is(".city-picker-input")&&(g=d),d.is(".city-picker-dropdown")?e=d:d.is(".city-picker-dropdown *")&&(e=d.parents(".city-picker-dropdown")),(!g&&!f&&!e||f&&f.get(0)!==b.$textspan.get(0)||g&&g.get(0)!==b.$element.get(0)||e&&e.get(0)!==b.$dropdown.get(0))&&b.close(!0)}),this.$element.on("change",this._changeElement=a.proxy(function(){this.close(!0),this.refresh(!0)},this)).on("focus",this._focusElement=a.proxy(function(){this.needBlur=!0,this.open()},this)).on("blur",this._blurElement=a.proxy(function(){this.needBlur&&(this.needBlur=!1,this.close(!0))},this)),this.$textspan.on("click",function(c){var e,d=a(c.target);b.needBlur=!1,d.is(".select-item")?(e=d.data("count"),b.open(e)):b.$dropdown.is(":visible")?b.close():b.open()}).on("mousedown",function(){b.needBlur=!1}),this.$dropdown.on("click",".city-select a",function(){var c=a(this).parents(".city-select"),e=c.find("a.active"),f=0===c.next().length;e.removeClass("active"),a(this).addClass("active"),e.data("code")!==a(this).data("code")&&(c.data("item",{address:a(this).attr("title"),code:a(this).data("code")}),a(this).trigger(d),b.feedText(),b.feedVal(!0),f&&b.close())}).on("click",".city-select-tab a",function(){if(!a(this).hasClass("active")){var c=a(this).data("count");b.tab(c)}}).on("mousedown",function(){b.needBlur=!1}),this.$province&&this.$province.on(d,this._changeProvince=a.proxy(function(){this.output(f),this.output(g),this.tab(f)},this)),this.$city&&this.$city.on(d,this._changeCity=a.proxy(function(){this.output(g),this.tab(g)},this))},open:function(a){a=a||e,this.$dropdown.show(),this.$textspan.addClass("open").addClass("focus"),this.tab(a)},close:function(a){this.$dropdown.hide(),this.$textspan.removeClass("open"),a&&this.$textspan.removeClass("focus")},unbind:function(){a(document).off("click",this._mouteclick),this.$element.off("change",this._changeElement),this.$element.off("focus",this._focusElement),this.$element.off("blur",this._blurElement),this.$textspan.off("click"),this.$textspan.off("mousedown"),this.$dropdown.off("click"),this.$dropdown.off("mousedown"),this.$province&&this.$province.off(d,this._changeProvince),this.$city&&this.$city.off(d,this._changeCity)},getText:function(){var b="";return this.$dropdown.find(".city-select").each(function(){var c=a(this).data("item"),d=a(this).data("count");c&&(b+=(a(this).hasClass("province")?"":"/")+'<span class="select-item" data-count="'+d+'" data-code="'+c.code+'">'+c.address+"</span>")}),b},getPlaceHolder:function(){return this.$element.attr("placeholder")||this.options.placeholder},feedText:function(){var a=this.getText();a?(this.$textspan.find(">.placeholder").hide(),this.$textspan.find(">.title").html(this.getText()).show()):(this.$textspan.find(">.placeholder").text(this.getPlaceHolder()).show(),this.$textspan.find(">.title").html("").hide())},getVal:function(){var b="";return this.$dropdown.find(".city-select").each(function(){var c=a(this).data("item");c&&(b+=(a(this).hasClass("province")?"":"/")+c.address)}),b},feedVal:function(a){this.$element.val(this.getVal()),this.feedValCode(),a&&this.$element.trigger("cp:updated")},getValCode:function(){var a=this.$dropdown.find(".city-select.district").data("item")||this.$dropdown.find(".city-select.city").data("item")||this.$dropdown.find(".city-select.province").data("item");return a?a.code:""},feedValCode:function(){return this.$elementCode.length?void this.$elementCode.val(this.getValCode()):void alert("请在初始化参数中指定valueField或添加hidden字段存储code值")},output:function(c){var j,k,l,n,d=this.options,h=this["$"+c],i=c===e?{}:[],m=null;h&&h.length&&(j=h.data("item"),n=(j?j.address:null)||d[c],l=c===e?86:c===f?this.$province&&this.$province.find(".active").data("code"):c===g?this.$city&&this.$city.find(".active").data("code"):l,k=a.isNumeric(l)?b[l]:null,a.isPlainObject(k)&&a.each(k,function(a,b){var d;if(c===e){d=[];for(var f=0;f<b.length;f++)b[f].address===n&&(m={code:b[f].code,address:b[f].address}),d.push({code:b[f].code,address:b[f].address,selected:b[f].address===n});i[a]=d}else b===n&&(m={code:a,address:b}),i.push({code:a,address:b,selected:b===n})}),h.html(c===e?this.getProvinceList(i):this.getList(i,c)),h.data("item",m))},getProvinceList:function(b){var c=[],d=this,f=this.options.simple;return a.each(b,function(b,g){c.push('<dl class="clearfix">'),c.push("<dt>"+b+"</dt><dd>"),a.each(g,function(a,b){c.push('<a title="'+(b.address||"")+'" data-code="'+(b.code||"")+'" class="'+(b.selected?" active":"")+'">'+(f?d.simplize(b.address,e):b.address)+"</a>")}),c.push("</dd></dl>")}),c.join("")},getList:function(b,c){var d=[],e=this,f=this.options.simple;return d.push('<dl class="clearfix"><dd>'),a.each(b,function(a,b){d.push('<a title="'+(b.address||"")+'" data-code="'+(b.code||"")+'" class="'+(b.selected?" active":"")+'">'+(f?e.simplize(b.address,c):b.address)+"</a>")}),d.push("</dd></dl>"),d.join("")},simplize:function(a,b){return a=a||"",b===e?a.replace(/[省,市,自治区,壮族,回族,维吾尔]/g,""):b===f?a.replace(/[市,地区,回族,蒙古,苗族,白族,傣族,景颇族,藏族,彝族,壮族,傈僳族,布依族,侗族]/g,"").replace("哈萨克","").replace("自治州","").replace(/自治县/,""):b===g?a.length>2?a.replace(/[市,区,县,旗]/g,""):a:void 0},tab:function(a){var b=this.$dropdown.find(".city-select"),c=this.$dropdown.find(".city-select-tab > a"),d=this["$"+a],e=this.$dropdown.find('.city-select-tab > a[data-count="'+a+'"]');d&&(b.hide(),d.show(),c.removeClass("active"),e.addClass("active"))},reset:function(){this.$element.val(null).trigger("change")},destroy:function(){this.unbind(),this.$element.removeData(c).removeClass("city-picker-input"),this.$textspan.remove(),this.$dropdown.remove()}},h.DEFAULTS={simple:!1,responsive:!1,placeholder:"请选择省/市/区",level:"district",province:"",city:"",district:""},h.setDefaults=function(b){a.extend(h.DEFAULTS,b)},h.other=a.fn.citypicker,a.fn.citypicker=function(b){var d=[].slice.call(arguments,1);return this.each(function(){var g,i,e=a(this),f=e.data(c);if(!f){if(/destroy/.test(b))return;g=a.extend({},e.data(),a.isPlainObject(b)&&b),e.data(c,f=new h(this,g))}"string"==typeof b&&a.isFunction(i=f[b])&&i.apply(f,d)})},a.fn.citypicker.Constructor=h,a.fn.citypicker.setDefaults=h.setDefaults,a.fn.citypicker.noConflict=function(){return a.fn.citypicker=h.other,this},a(function(){a('[data-toggle="city-picker"]').citypicker()})});